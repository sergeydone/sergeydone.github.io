<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Postgresql DB replication">
<meta name="keywords" content="Postgresql, replication, Windows">
<title>Postgresql DB replication</title>
</head>
<body>
<nav> <a href = "index2.html"> --- Up </a></nav>

<h1>Postgresql DB replication  </h1>

<h2> # Setup Postrgesql DB replication
with wal archives:</h2>



<div> # 1 ####### Install Postgresql master </div>
<pre>
sudo dnf install postgresql postgresql-server
systemctl postgresql enable
systemctl postgresql start
</pre>
<div>&nbsp</div>

<div># 2 ####### Install Postgresql slave</div>
<pre>sudo dnf install postgresql postgresql-server</pre>
<div>&nbsp</div>


<div> # 3 ####### Create DB Master </div>
<pre>sudo su postgres

psql

create database mydb;

\c mydb

create table test_table (
id serial primary key,
name varchar(100),
email varchar(100),
createdat timestamp default current_timestamp);

insert into test_table (name, email, createdat)
select
'Name ' || gs.i,
'name' || gs.i || '@example.com',
NOW()
from generate_series(100000, 200000) as gs(i);

CREATE USER replica REPLICATION LOGIN CONNECTION LIMIT 2 ENCRYPTED PASSWORD 'StrongPassword'

</pre>
<div>&nbsp</div>

<div># 4 ####### Setup Master DB </div>
<pre>
vi /var/lib/pgsql/data/postgesql.conf
listen_addresses = '*'
password_encription = md5
wal_level = replica
archive_mode = on
arhive command = 'cp %p /var/lib/pgsql/wal_archive/%f'
archive timeout = 60

vi /var/lib/pgsql/data/pg_hba.conf
host  all  all  0.0.0.0/0   md5
host  replication replica 0.0.0.0/0 md5
</pre>
<div>&nbsp</div>

<div># 5 ####### Setup Master Archive Folder </div>
<pre>
sudo mkdir -p /var/lib/pgsql/wal_archive
sudo chown postgres:postgres /var/lib/pgsql/wal_archive
chmod 700 /var/lib/pgsql/wal_archive
</pre>
<div>&nbsp</div>

<div># 6 ####### Setup Master Firewall  (optional)</div>
<pre>
sudo firewall-cmd --permanent --add-service=postgresql
sudo firewall-cmd --reload
</pre>
<div>&nbsp</div>

<div># 7 ####### Setup Slave Archive Folder </div>
<pre>
sudo mkdir -p /var/lib/pgsql/wal_archive
sudo chown postgres:postgres /var/lib/pgsql/wal_archive
chmod 700 /var/lib/pgsql/wal_archive
</pre>
<div>&nbsp</div>

<div># 8 ####### Setup Slave DB</div>
<pre>
sudo rm -rf /var/lib/pgsql/data/*

pg_basebackup -h fedoraA -D /var/lib/pgsql/data -U replica -P -R --wal-method=stream

sudo chown -R postgres:postgres /var/lib/pgsql/data
sudo chmod 700 /var/lib/pgsql/data

sudo rm -f /var/lib/pgsql/data/postgesql.auto.conf

vi /var/lib/pgsql/data/postgresql.conf
listen_addresses = '*'
password_encription = md5
wal_level = replica
# ##archive_mode = on
# ##arhive command = 'cp %p /var/lib/pgsql/wal_archive/%f'
# ##archive timeout = 60
restore_command = 'cp /var/lib/pgsql/wal_archive/%f %p'
hot_stanby = on

touch /var/lib/pgsql/data/standby.signal

systemctl enable postgresql
systemctl start postgresql

</pre>
<div>&nbsp</div>


<div># 9 ####### Setup Master Firewall (optional) </div>
<pre>
sudo firewall-cmd --permanent --remove-service=postgresql
sudo firewall-cmd --reload
</pre>
<div>&nbsp</div>

<div> # 10 ####### COPY wal files from Master to Slave </div>
<pre>
rsync -avz -e "ssh -p 22" /var/lib/pgsql/wal_archive/ root@IPADDRESS:/var/lib/pgsql/wal_archive/ 
</pre>
<div>&nbsp</div>

<div># 11 ####### Examine the logs  </div>
<pre>
sudo journalctl -u postgresql -f
sudo journalctl -u postgresql.service -b --no-pager | tail -n 50
journalctl -xeu postgresql.service
</pre>


<div>&nbsp</div>







 

<details>
<summary>
================ADDITION==================
</summary>

<div>#  ####### Alternate way to copy start DB before replication  </div>
<pre>
sudo systemctl stop postgresql
rsync -avz /var/lib/pgsql/data/ user@fedoraB:/var/lib/pgsql/data/
sudo chown -R postgres:postgres /var/lib/pgsql/data/
</pre>
<div>&nbsp</div>

<div> # Test basic TCP connec </div>
<pre>
sudo dnf install -y telnet  # If telnet not installed
telnet 192.168.1.1 5432
</pre>
<div>&nbsp</div>

<div># Or use netcat</div>
<pre>
sudo dnf install nc
nc -zv 192.168.1.1 5432
</pre>
<div>&nbsp</div>

<div># Or with PostgreSQL client</div>
<pre>
psql -h 192.168.1.1 -p 5432 -U youruser -d yourdb
</pre>
<div>&nbsp</div>


<div># Open firewall options</div>
<pre>
sudo firewall-cmd --permanent --add-port=5432/tcp
sudo firewall-cmd --add-service=postgresql
sudo firewall-cmd --list-services
sudo firewall-cmd --permanent --remove-service=postgresql
sudo firewall-cmd --reload
sudo firewall-cmd --zone=public --remove-service=postgresql
sudo firewall-cmd --zone=public --permanent --remove-service=postgresql
sudo firewall-cmd --reload
</pre>
<div>&nbsp</div>


<div># Verify the firewall rule</div>
<pre>
sudo firewall-cmd --list-all
</pre>
<div>&nbsp</div>

<div># Wireshark</div>
<pre>
sudo dnf install wireshark-cli
sudo tshark -i any
sudo tshark -i any -f "port 5432"
sudo tshark -i any -f "src host 172.234.103.137"
sudo tshark -i any -f "dst host 172.234.103.137"
-t u (UTC time):
</pre>
<div>&nbsp</div>


<div># Set timezone</div>
<pre>
sudo timedatectl set-timezone Europe/Kyiv
timedatectl list-timezones
timedatectl
</pre>
<div>&nbsp</div>

</details>
</body>